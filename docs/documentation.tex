\documentclass{article}

% ############### %
% PACKAGE IMPORTS %
% ############### %
\usepackage[utf8]{inputenc}

\usepackage{amsmath}
\usepackage{amssymb}
%\usepackage[margin=80pt]{geometry}
\usepackage{fancyhdr}
\usepackage{graphicx}
\usepackage[hidelinks]{hyperref}
\usepackage{longtable}
\usepackage{mathtools}
\usepackage[most]{tcolorbox}
\usepackage{tikz}
\usetikzlibrary{shadows}

\pagestyle{fancy}

\newcommand{\greencheck}{{\color{green}\checkmark}}
\newcommand{\redcross}{{\color{red}$\times$}}

% ################ %
% ENVIRONMENT DEFS %
% ################ %
\newenvironment{guide}[1]
{
	\begin{center}
		\begin{tcolorbox}[%
			colback=black!20, 
			boxrule=0pt, 
			title=Step-by-step: #1,
			enhanced,
			breakable,
			overlay unbroken={%
                \draw[line width=1pt, black, rounded corners]
        	    (frame.north west) rectangle (frame.south east);
			},
    		overlay first={%
        		 \draw[line width=1pt, black, rounded corners]
        	    (frame.south west) -- (frame.north west) -- (frame.north east) -- (frame.south east);
                \draw[line width=1pt, black]
                (frame.south west) -- (frame.south east);
            },
    		overlay middle={%
                \draw[line width=1pt, black]
        	    (frame.north west) rectangle (frame.south east);
        	},
    		overlay last={%
                \draw[line width=1pt, black, rounded corners]
        	    (frame.north west) -- (frame.south west) -- (frame.south east) -- (frame.north east);
                \draw[line width=1pt, black]
                (frame.north west) -- (frame.north east);
           	}
        ]{}
    	\begin{enumerate}
}
{
    		\end{enumerate}
    	\end{tcolorbox}
	\end{center}  	 
}

\newcommand{\guideimage}[1]
{
	\begin{center}
		\includegraphics[width=0.5\textwidth]{#1}
	\end{center}
}


% Adapted from this StackExchange post:
% https://tex.stackexchange.com/a/5227
\newcommand*\keystroke[1]
{
	\raisebox{-1.5pt}
	{
		\hspace{-8pt}
		\begin{tikzpicture}
		\node
		[
			draw,
			fill=black!65,
			drop shadow={shadow xshift=0.25ex,shadow yshift=-0.25ex,fill=black,opacity=0.75},
      		rectangle,
      		rounded corners=2pt,
      		inner sep=3pt,
      		outer sep=0pt,
      		line width=0.5pt,
      		font=\scriptsize\sffamily,
      		text=black!10
    	]
    	{
    		\hspace*{0.5pt}\tt #1\hspace*{0.5pt}
    	}
    	;
    	\end{tikzpicture}
		\hspace{-8pt}
  	}
}


% ############## %
% LISTINGS STUFF %
% ############## %
% FROM https://tex.stackexchange.com/a/656423
% Default fixed font does not support bold face
\DeclareFixedFont{\ttb}{T1}{txtt}{bx}{n}{12} % for bold
\DeclareFixedFont{\ttm}{T1}{txtt}{m}{n}{12}  % for normal

% Custom colors
\usepackage{color}
\definecolor{deepblue}{rgb}{0,0,0.5}
\definecolor{deepred}{rgb}{0.6,0,0}
\definecolor{deepgreen}{rgb}{0,0.5,0}

\usepackage{listings}



\lstdefinestyle{pythonstyling}{
language=Python,
basicstyle=\ttm\small,
morekeywords={self},              % Add keywords here
keywordstyle=\ttb\small\color{deepblue},
emph={__init__},          % Custom highlighting
emphstyle=\ttb\small\color{deepred},    % Custom highlighting style
stringstyle=\color{deepgreen},
frame=tb,                         % Any extra options here
showstringspaces=false,
numbers=left,
stepnumber=1,
tabsize=1,
breaklines=true,
breakatwhitespace=false,
}

% ############## %
% VARIABLE SETUP %
% ############## %
\title{Blender Tools for GFS Documentation}
\author{Pherakki}
\date{v0.1}


% ############## %
% DOCUMENT START %
% ############## %
\begin{document}
\maketitle
\pagenumbering{gobble}
\clearpage

\tableofcontents
\clearpage

\pagenumbering{arabic} 

\section{Getting Started}
BlenderToolsForGFS is a \textbf{Blender 2.81+} plugin. It should work on all versions of Blender including and beyond 2.81 that are compatible with the 2.81 API. The plugin has been developed on versions 2.83 and 3.4.1. You should install and remove it like any other Blender plugin.

\subsection{A Note on Expectations}
This plugin should be viewed as a \textbf{supplement} to existing model-editing tools, and not as a replacement. You should, in particular, post-process any models exported from Blender in \textbf{GFD Studio}, following existing tutorials and knowledge to achieve your goals.

Please also note that although this document does offer a number of guides on bits of basic Blender usage required to use the plugin, this is not a guide on how to use Blender. If you are intending to work with models and animations, it is ultimately your responsibility to learn how to use Blender using the wealth of resources available on the internet.

This is also not a guide on how to mod games. Again, it is your responsibility to seek out or discover the information you require to attain any such goals.

What this guide \textit{is} intended for is to assist you in successfully exporting data from Blender to the GFS file format. Suggestions for improvements on how to do that are very much welcomed, as long as they do not fall out-of-scope for the essential use of the plugin.
\clearpage

\section{Import}
\subsection{Import Restrictions}
Currently, a subset of features of the GFS format are not supported by the plugin and cannot be exported. These are:
\begin{itemize}
\item File versions outside of the range 0x01104920 - 0x01105100
\end{itemize}
\noindent
There are also some additional considerations to bear in mind.
\begin{itemize}
\item Only non-BC7 DDS texture slots are currently importable in models.
\item There is a lot of extra data, such as EPL effects and physics, that is not explicity expressed as Blender data but is still attached to the model for export. This data is non-interactable from Blender in the current version. If some chunk of data is not mentioned in the documentation, you can assume that it is probably stored in this fashion.
\end{itemize}

\clearpage 

\subsection{Importing Model (GMD/GFS) Files}
\begin{guide}{Accessing the Model Import Menu}
\item Open the File menu and navigate to the \textbf{Import} \textgreater\space \textbf{GFS} \textgreater\space \textbf{GFS Model} submenu item.
\guideimage{images/import/import_gmd.png}
\item Select which settings you wish to use for import from the options on the right.
\guideimage{images/import/import_gmd_properties.png}
\begin{itemize}
\item \textbf{Align Animation Quaternions}: If the animation contains rotation flips, tick this box to fix the imported data. This is off by default since it increases the import time.
\item \textbf{Animation Bounding Boxes}: This setting has two options. It is set to \textbf{Auto} by default.
\begin{itemize}
\item \textbf{Original}: Imports all bounding boxes as ``manual" boxes. This means that the bounding boxes will not be automatically re-calculated on export if a mesh or animation is changed. This is useful if a model contains bounding boxes that have been manually set that you want to preserve. This setting can be changed for each bounding box individually inside Blender.
\item \textbf{Auto}: Imports all bounding boxes as ``Auto" boxes. This means that the bounding boxes will be automatically re-calculated on export for all meshes and animations. This setting can be changed for each bounding box individually inside Blender.
\end{itemize}
\item \textbf{Set Blender FPS to 30}: Change the default animation speed from Blender's default 24 FPS to Persona 5 Royal's 30 FPS animation playback speed.
\item \textbf{Set P5R Screen Clip}: Increase the default screen clip distance to 10000 so that the large Persona 5 Royal models do not get culled at zoom distances large enough to view the entire model.
\item \textbf{Bind Pose}: Choose how to construct the bind pose of the imported model. The default (and recommended, unless you have a buggy model) option is \textbf{Reconstruct}.
\begin{itemize}
\item \textbf{Reconstruct}: Reconstructs the true bind pose using the model data.
\begin{itemize}
\item[\greencheck] Mesh vertices are unaltered, which makes rotating and scaling meshes work as intended.
\item[\redcross] Skinned meshes will import into incorrect positions if their positioning matrices have shear components.
\item[\redcross] Will not reproduce in-engine vertex positions if the model has an error where the mesh-positioning node transforms are inconsistent with the mesh-relative bind pose matrices in the file.
\end{itemize}
\item \textbf{Scaleless Rest Pose}: This will deform the mesh to a ficticious bind pose created from the node translations and rotations. 
\begin{itemize}
\item[\greencheck] Meshes will be positioned correctly, even if they have shear elements in their transforms.
\item[\greencheck] Will reproduce in-engine vertex positions even if the model has an error where the mesh-positioning node transforms are inconsistent with the mesh-relative bind pose matrices in the file.
\item[\redcross] Meshes will rotate and scale relative to the model origin, and not as intended.
\item[\redcross] Meshes may be deformed in Edit Mode if the ficticious bind pose and the rest pose are dissimilar.
\item[\redcross] The ficticious bind pose may not be as useful as the true bind pose for editing the model geometry.
\end{itemize}
\end{itemize}
\item \textbf{Connect Child Bones}: Attempt to set bones to ``connected" if they can be lined up head-to-tail.
\end{itemize}
\item Select the GMD or GFS file to import using the file browser.
\end{guide}

\clearpage

\subsection{Importing Animation (GAP) Files}
\begin{guide}{Accessing the Animation Import Menu}
\item Ensure that you have first imported the model that the animation is modelled for.
\item Open the File menu and navigate to the \textbf{Import} \textgreater\space \textbf{GFS} \textgreater\space \textbf{GAP Animation} submenu item.
\guideimage{images/import/import_gap.png}
\item Select which settings you wish to use for import from the options on the right.
\guideimage{images/import/import_gap_properties.png}
\begin{itemize}
\item \textbf{Armature}: The armature which the GAP is to be associated with.
\item \textbf{Align Animation Quaternions}: If the animation contains rotation flips, tick this box to fix the imported data. This is off by default since it increases the import time.
\item \textbf{Animation Bounding Boxes}: This setting has two options. It is set to \textbf{Auto} by default.
\begin{itemize}
\item \textbf{Original}: Imports all bounding boxes as ``manual" boxes. This means that the bounding boxes will not be automatically re-calculated on export if a mesh or animation is changed. This is useful if a model contains bounding boxes that have been manually set that you want to preserve. This setting can be changed for each bounding box individually inside Blender.
\item \textbf{Auto}: Imports all bounding boxes as ``Auto" boxes. This means that the bounding boxes will be automatically re-calculated on export for all meshes and animations. This setting can be changed for each bounding box individually inside Blender.
\end{itemize}
\item \textbf{Set Blender FPS to 30}: Change the default animation speed from Blender's default 24 FPS to Persona 5 Royal's 30 FPS animation playback speed.
\item \textbf{Set P5R Screen Clip}: Increase the default screen clip distance to 10000 so that the large Persona 5 Royal models do not get culled at zoom distances large enough to view the entire model.
\end{itemize}
\item Select the GAP file to import using the file browser.
\end{guide}

\clearpage

\subsection{Blender Settings}
\subsubsection{Previewing Materials}
Many beginners to Blender are confused by the fact that models do not display their materials when it is first opened. Blender by default renders models in a ``Solid" representation that is useful for modellers editing meshes. You can preview materials instead by changing this render setting.
\begin{guide}{Previewing Materials}
\item Locate the \textbf{Viewport Shading} widget and select \textbf{Material Preview} mode.
\guideimage{images/import/import_preview_materials.png}
\end{guide}

\subsubsection{Importing Large Models}
\label{SECTION::ImportingLargeModels}
Some models, such as Field Models, might exceed the render distance of Blender. In this instance, you may find it useful to increase Blender's render distance.\\
\begin{guide}{Increasing Blender's Render Distance}
\item Press the \keystroke{N} key to open the \textbf{Sidebar}.
\guideimage{images/import/import_field_open_menu.png}
\item Click the \textbf{View} tab in the \textbf{Sidebar}.
\guideimage{images/import/import_field_open_view.png}
\item Change the value in the \textbf{End} box to a value large enough for you to comfortably navigate the model.
\guideimage{images/import/import_field_set_distance.png}
\item Press the \keystroke{N} key to close the \textbf{Sidebar}.
\end{guide}

\subsubsection{Hiding Unused Bones}
On import, three bone layers will be created in the armature:
\begin{itemize}
\item All Bones
\item Bones used in Vertex Groups
\item Bones not used in Vertex Groups
\end{itemize}
Selecting one of these layers will allow you to hide these subsets of bones. Note that these groups are created \textbf{by the plugin} on import, and if you add new bones to a model then it is up to you to add bones to whatever bone layers you want.

\begin{guide}{Selecting Bone Layers}
\item Switch to Object Mode.
\guideimage{images/import/import_to_object_mode.png}
\item Select the model armature.
\item Click the Armature icon in the Properties Panel. Select the Bone Layer that is active in the Viewport.
\guideimage{images/import/import_bone_layer_select.png}
\end{guide}

\clearpage

\section{Editing Models and Animations}
\subsection{GFS Models}
Models are imported as Armature objects with meshes, cameras, and lights parented below them. Most of the objects imported from GFS files can carry additional information beyond pure geometry and shading data, which is outlined in the proceeding sections.

GFS models are very large compared to typical Blender scales. If parts of the model disappear as you zoom out, you will need to change the render distance of Blender as described in section \ref{SECTION::ImportingLargeModels}.

The data in the files are assumed to be oriented Y-up and with X-axis-oriented bones. During import, these are converted to the Z-up orientation and Y-axis-oriented bones to match the Blender conventions. On export, the Blender data is converted back to Y-up orientation and X-axis-oriented bones. 

\subsubsection{Bones}
\label{SECTION::EditingBones} 
There are no special considerations for bones beyond how they behave in Blender. However, bones do also have some additional information that can be attached to them not representable in Blender. These can be accessed from the \textbf{GFS Node} panel in the \textbf{Bone Properties}.

\begin{itemize}
\item \textbf{Unknown Float}: Unknown. Always seems to take a value of 1.
\item \textbf{Properties}: Custom properties attached to the bone. See section \ref{SECTION::GfsProperties} for further details.
\end{itemize}

\begin{guide}{Accessing Extra Bone Properties}
\item Select the armature of the model either in the Viewport or in the Outliner.
\guideimage{images/editing_models/edits_select_armature.png}
\item Switch to Pose Mode.
\guideimage{images/editing_models/edits_to_pose_mode.png}
\item Select a bone and select the Bone icon in the Properties panel. You will find a panel called ``GFS Node" containing the additional Bone Properties.
\guideimage{images/editing_models/edits_bone_properties.png}
\end{guide}
\clearpage

\subsubsection{Rest Pose}
GFS models have a \textbf{rest pose} in addition to the bind pose. The bones are imported in the \textbf{bind pose}, and the \textbf{rest pose} is added as a single-frame animation. The \textbf{rest pose} is used as a ``default transform" for any animations, such that any bones without animation data uses the \textbf{rest pose} instead. If you want the \textbf{rest pose} to differ from the \textbf{bind pose}, create a single-frame action and push it to an NLA track called \textbf{Rest Pose}. This should always be at the \textbf{bottom} of the NLA editor, since it should have the lowest priority.

\subsubsection{Meshes}
Meshes that belong to a GFS model are parented under an armature. Meshes can use an armature deform with vertex groups as usual inside Blender. However, each vertex is only allowed to be part of a maximum of 4 vertex groups, and a maximum of 256 inverse bind pose matrices are permitted across the entire model. The exporter will attempt to re-use inverse bind pose matrices where possible to create a minimal palette, but this does mean that in the worse-case scenario only 256 vertex groups can be used across all rigged meshes. In practice the limit will be higher due to the aforementioned matrix re-use.


\begin{guide}{Parenting Objects within Blender}
\item Select the child object in the outliner or in the viewport.
\guideimage{images/editing_models/edits_parent_1.png}
\item Select the parent object in the outliner or in the viewport with \keystroke{Ctrl} + Click.
\guideimage{images/editing_models/edits_parent_2.png}
\item Press \keystroke{Ctrl} + \keystroke{P} with the mouse in the Viewport.
\item Select either:
\begin{enumerate}
\item \textbf{Object (Without Inverse)} if you want to parent the object and reset its transform.
\item \textbf{Object (Keep Transform Without Inverse)} if you want to parent the object \textbf{and} edit the mesh's transform so that it stays in the same place in the viewport.
\end{enumerate}
\guideimage{images/editing_models/edits_parent_3.png}
\item In any situation, if after parenting your child object's transform is not what you expected, then:
\begin{itemize}
\item Select the child object.
\item Press \keystroke{Alt} + \keystroke{P} with the mouse in the Viewport.
\item Click \textbf{Clear Parent Inverse}.
\end{itemize}
This will remove the hidden ``parent inverse" matrix that sometimes gets inserted when parenting objects. This is harmless, but merely means that you object's transform may not align with what you see in the viewport if it is not a unit transform.\\
\guideimage{images/editing_models/edits_clear_parent_transform.png}
\end{guide}


\begin{guide}{Unparenting Objects within Blender}
\item Select an object in the outliner or in the viewport.
\item Press \keystroke{Alt} + \keystroke{P} with the mouse in the Viewport.
\item Select either:
\begin{enumerate}
\item \textbf{Clear Parent} if you want to unparent the object from its parent \textbf{and} move the mesh so that its transform is relative to the origin.
\item \textbf{Clear and Keep Transform} if you want to unparent the object from its parent \textbf{and} edit the mesh's transform so that it stays in the same place in the viewport.
\end{enumerate}
Ignore \textbf{Clear Parent Inverse}.
\guideimage{images/editing_models/editing_unparent.png}
\end{guide}

Meshes have certain attributes that may be exported and operations that can be performed on the mesh. These are given in the \textbf{GFS Mesh} submenu.
\begin{itemize}
\item \textbf{Auto-Rename UVs}: Rename the UV maps of the mesh to names that can be recognised by the plugin's material system. In practice this will rename the first 7 UV maps to UVs \textbf{UV0} through \textbf{UV6}.
\item \textbf{State}: This is an uneditable label stating how the mesh will be exported, given the current state of the mesh. The options are:
\begin{itemize}
\item Rigged [Attached]: The mesh vertices are rigged and the mesh itself will be exported relative to a specified bone.
\item Rigged [New Node]: The mesh vertices are rigged and a new node will be created on export for the mesh to be attached to.
\item Unrigged [Attached]: The mesh acts as if entirely rigged to a single bone which it specifies. This is more performant than actually being rigged to a single bone.
\item Unrigged [New Node]: The mesh acts as if entirely rigged to a single bone, which is created on export. This is more performant than actually being rigged to a single bone.
\end{itemize}
\item \textbf{Node}: The bone that a mesh will be exported relative to. If empty, a new bone will be created for the mesh on export.
\item \textbf{Convert to Unrigged}: Clicking this will pop up a bone selection menu. Selecting a bone will make the mesh act as if it is fully rigged to the selected bone.
\item \textbf{Permit Export as Unrigged}: If a mesh uses only a single vertex group, allow export as an optimised ``unrigged" mesh rather than using the ``rigged" animation system.
\item \textbf{Bounding Box}: The option for exporting a bounding box for the mesh. The three options are:
\begin{itemize}
\item \textbf{Auto}: Automatically calculate a bounding box based on the mesh dimensions.
\item \textbf{Manual}: Manually specify a bounding box. Selecting this opens a submenu, where the bounding box for the mesh can be previewed.
\item \textbf{None}: Do not export a bounding box.
\end{itemize}
\item \textbf{Bounding Sphere}: The option for exporting a bounding sphere for a mesh. Identical in operation to the bounding box.
\item \textbf{Unknown Flags}: The purpose of these flags are not known. Checking and unchecking these may cause or fix crashes.
\item \textbf{Unknown 0x12}: Purpose unknown.
\item \textbf{GFS Node}: This sub-panel will be used if the mesh is in a ``New Node" state. Refer to section \ref{SECTION::EditingBones} for further details on the properties of this sub-panel.
\item \textbf{Unknown Floats}: If ticked, the mesh will be be exported with two additional floats. The purpose of these floats is unknown.
\end{itemize}

\begin{guide}{Accessing Extra Mesh Attributes}
\item Select the mesh in the Outliner or in the Viewport.
\guideimage{images/editing_models/edits_select_mesh.png}
\item Switch to Object Mode.
\guideimage{images/editing_models/edits_to_object_mode.png}
\item Select the Mesh icon in the Properties panel. You will find a panel called ``GFS Mesh" containing the additional Mesh attributes.
\guideimage{images/editing_models/edits_mesh_properties.png}
\end{guide}

\underline{\textbf{WARNINGS}}
\begin{itemize}
\item Many tutorials and help articles will tell you to \textbf{Apply Transforms} to your mesh to reset their transforms to a unit transform. \textbf{This is dangerous}. When you \textbf{Apply Transforms}, you are translating, rotating, and scaling the vertices that make up the mesh, rather than applying an extra transform on top of the mesh. This means that, for example, your mesh will now use the origin as the reference point from which it rotates and scales, rather than the point around which the mesh was modelled.
\end{itemize}

\subsubsection{Materials}
\label{SECTION::EditingMaterials}

Materials are not yet sufficiently understood to a degree whereby they can be consistently rendered in Blender. Therefore, materials are only represented in Blender as the Diffuse Texture of the material and all other properties are inferred from attributes or the names of Shader Nodes. Edits to the GFS Material attributes will, more often than not, simply lead to the model crashing any game that loads it. Due to this, editing materials from Blender is \textbf{not} currently recommended, except for the purposes of:
\begin{enumerate}
\item Adding textures to a material.
\item Perhaps minor tweaks to attributes.
\item Researching what the attributes do.
\end{enumerate}
You will have much more success following the strategy of current model editing guides: post-processing the model in \textbf{GFD Studio} by copying materials from other models onto your exported model. How to do this is beyond the scope of this documentation but detailed tutorials are available online.

In the future, when materials are properly understood, a custom Shader Node Group should be implemented that allows the material to be rendered in a meaningful fashion, and allowing the values of attributes to be auto-calculated such that they do not crash the game. \textbf{There is not enough knowledge currently to do this and any contributions to material research enabling this feature is highly welcomed.}

There are then two essential pieces to Material editing:
\begin{itemize}
\item Texture Samplers
\item GFS Material Attributes
\end{itemize}

\paragraph{Texture Samplers:}You can edit the textures used by a material by accessing the Shader Nodes. The first step is to open the Shader Node Editor.
\begin{guide}{Opening the Shader Node Editor}
\item Select the mesh in the Outliner or in the Viewport.
\guideimage{images/editing_models/edits_select_mesh.png}
\item Switch to Object Mode.
\guideimage{images/editing_models/edits_to_object_mode.png}
\item Select the Material icon in the Properties panel.
\guideimage{images/editing_models/edits_select_material.png}
\item Select the Shader Editor.
\guideimage{images/editing_models/edits_open_shader_nodes.png}
\end{guide}

You can then set create new samplers to be exported and set their GFS attributes. There are nine types of textures available in the GFS format. Each material can have \textbf{one} of each type, and the plugin will recognise which type of sampler a node represents by the \textbf{name} of the node. The recognised names are:
\begin{itemize}
\item Diffuse Texture
\item Normal Texture
\item Specular Texture
\item Reflection Texture
\item Highlight Texture
\item Glow Texture
\item Detail Texture
\item Night Texture
\item Shadow Texture
\end{itemize}

Note also that the UV maps must also have specific names due to the way they are stored in the GFS file format. The permitted names are:
\begin{itemize}
\item UV0
\item UV1
\item UV2
\item UV3
\item UV4
\item UV5
\item UV6
\end{itemize}
meaning that up to 7 maps are allowed per mesh.

\begin{guide}{Editing Texture Samplers}
\item Inside the Shader Editor, select or create an Image Node.
\item Select the \textbf{Node} tab in the Sidebar. If the Sidebar is not open, press \keystroke{N} with the mouse inside the Shader Editor.
\item Set the name of the node to one of the nine accepted names by changing the value in the Name field.
\guideimage{images/editing_models/edits_rename_shader_node.png}
\item Select or create a UV Map node. Select a UV map present on the mesh from the drop-down on the node and hook the UV connector up to the Vector connector on the Texture node.
\guideimage{images/editing_models/edits_set_node_uv_map.png}
\item You can access the properties of a texture sampler by selecting the \textbf{GFS Texture} tab in the Sidebar. The properties for the sampler are given in the \textbf{GFS Texture Sampler} panel.
\guideimage{images/editing_models/edits_texture_sampler_properties.png}
\end{guide}

\paragraph{GFS Material Attributes:}
\noindent Materials have certain attributes that may be exported. These are:
\begin{itemize}
\item \textbf{Unknown Flags}: The purpose of Unknown Flags is not known. Checking and unchecking these may cause or fix crashes.
\item \textbf{Enable Vertex Colors}: Use Color Map data on the mesh.
\item \textbf{Enable UV Anims}: Allow the UV coordinates of the mesh to be animated.
\item \textbf{Use Light 2}: Purpose unknown.
\item \textbf{Purple Wireframe}: Render the mesh as a purple wireframe.
\item \textbf{Requires Normals}: Whether the material requires vertex normals to work. If this is active, any meshes using this material will be exported with vertex normals.
\item \textbf{Requires Tangents}: Whether the material requires vertex tangents to work. If this is active, any meshes using this material will be exported with vertex tangents.
\item \textbf{Requires Binormals}: Whether the material requires vertex binormals to work. If this is active, any meshes using this material will be exported with vertex binormals.
\item \textbf{Requires Color0}: Whether the material requires vertex colours in slot 0 to work. If this is active, any meshes using this material will be exported with vertex colours taken from a Color map called ``Map0" if it exists; if it does not, the mesh will be exported with an opaque white colour (1.0, 1.0, 1.0, 1.0) at each vertex.
\item \textbf{Requires Color1}: Whether the material requires vertex colours in slot 1 to work. If this is active, any meshes using this material will be exported with vertex colours taken from a Color map called ``Map1" if it exists; if it does not, the mesh will be exported with an opaque white colour (1.0, 1.0, 1.0, 1.0) at each vertex.
\item \textbf{In/Out UVs}: The in and out texcoords of the vertex shader. The \textbf{in} coords are determined from the shader tree. The\textbf{out} coords are settable manually, and are usually the same as the \textbf{in} coords.
\end{itemize}
\begin{guide}{Accessing Extra Material Attributes}
\item Select the mesh in the Outliner or in the Viewport.
\guideimage{images/editing_models/edits_select_mesh.png}
\item Switch to Object Mode.
\guideimage{images/editing_models/edits_to_object_mode.png}
\item Select the Material icon in the Properties panel. You will find a panel called ``GFS Material" containing the additional Material attributes.
\guideimage{images/editing_models/edits_material_properties.png}
\end{guide}

\subsubsection{Textures}
Textures must be DDS images with either no compression, or DXT1, DX3, or DXT5 compression. BC7 textures cannot currently be loaded by Blender and are currently unsupported. In the future, BC7 textures should be loadable \textit{via} an automatic conversion to a Blender-readable format.

\noindent Materials have certain attributes that may be exported. These are:
\begin{itemize}
\item \textbf{Unknown 1}: Purpose unknown.
\item \textbf{Unknown 2}: Purpose unknown.
\item \textbf{Unknown 3}: Purpose unknown.
\item \textbf{Unknown 4}: Purpose unknown.
\end{itemize}
These attributes can be edited from the \textbf{GFS Texture} Sidebar panel on a Texture Image node in the Shader Editor, as described in section \ref{SECTION::EditingMaterials}.

\subsubsection{Cameras}
Cameras are constrained to a bone in the model armature with a \textbf{Child Of} constraint. Due to the way that bones are imported, \textbf{you will need a 90 degree rotation in the Z axis} on the camera to make it point ``horizontally". The camera will be exported in whatever orientation it is in within Blender, however \textbf{it is strongly recommended} to just keep a 90-degree Z-rotation on the camera and do all other positioning using the bone it is constrained to.

For a camera to be recognised for export, you must do one of the following:
\begin{itemize}
\item Constrain the camera to follow a bone with a ``Child Of" constraint.
\item Parent the Camera to a bone. Note that parenting a Camera to a bone will place the camera at the tail of the bone rather than the head, although this should not affect the pose in which the camera is exported.
\end{itemize}

Some properties of Blender cameras will be exported to GFS camera properties, and some properties are not represented in Blender. This is described below.
\begin{guide}{Accessing Camera Properties}
\item In the \textbf{Camera Data} Properties panel, there are a number of camera properties. In the \textbf{Lens} section, the \textbf{Type} must be set to \textbf{Perspective} and the \textbf{Lens Unit} to \textbf{Field of View}. The \textbf{Field of View} attribute will be exported, although it may not exactly match up with the in-game field-of-view in the current version of the plugin. Additionally, the \textbf{Clip Start} and \textbf{Clip End} fields will be exported and will appear in-game as they do in Blender.
\item Furthermore, there are two properties not represented in Blender that can be exported, found in the \textbf{GFS Camera}. \textbf{Aspect Ratio}s can be represented in Blender, but only for the entire scene and not for individual cameras, so this is not currently represented. \textbf{Unknown 0x50} is unknown.
\guideimage{images/editing_models/edits_camera_properties.png}
\end{guide}

\subsubsection{Lights}
Lights are constrained to a bone in the model armature with a \textbf{Child Of} constraint. Due to the way that bones are imported, \textbf{you will need a 90 degree rotation in the Z axis} on the camera to make it point ``horizontally". The light will be \textbf{exported assuming a 90-degree Z-rotation on the light}---do all other positioning using the bone it is constrained to.

For a light to be recognised for export, you must do one of the following:
\begin{itemize}
\item Constrain the Light to follow a bone with a ``Child Of" constraint.
\item Parent the Light to a bone. Note that parenting a Light to a bone will place the light at the tail of the bone rather than the head, \textbf{and the light will be repositioned to the head of the bone during export due to GFS file format constraints}.
\end{itemize}

Some properties of Blender lights will be exported to GFS light properties, and some properties are not represented in Blender. This is described below.
\begin{guide}{Accessing Light Properties}
\item In the \textbf{Light Data} Properties panel, there are a number of light properties.
The only Blender property currently exported is the \textbf{Color} property, which sets the RGB light color.
\item The additional properties are in the \textbf{GFS Light} panel. There are first three elements common to all lights:
\begin{itemize}
\item \textbf{Color Alpha} is the alpha channel of the light color.
\item \textbf{Color 1} is a color variable that does not seem to be used.
\item \textbf{Color 3} is a color variable that does not seem to be used.
\end{itemize}
There are then three kinds of light, selectable from the drop-down:
\begin{itemize}
\item \textbf{Type 1}: Unknown light type, does not appear to render in-game. Has no specific properties.
\item \textbf{Sphere}: A point light that can have an attentuation radius. This has the unknown properties \textbf{unknown 0x34}, \textbf{unknown 0x38}, and \textbf{unknown 0x3C}, plus an \textbf{unknown setting}. If the unknown setting is active, the point light will illuminate everything within the \textbf{inner radius}, and attenuate to zero illumination between the \textbf{inner radius} and \textbf{outer radius}. Switching the setting off instead provides the settings \textbf{unknown 0x48}, \textbf{unknown 0x4C}, and \textbf{unknown 0x50}. Attempts to get a light to render using these variables have been unsuccessful.
\item \textbf{Hemisphere}: A spot light that can have an attentuation radius. This has the unknown properties \textbf{unknown 0x54}, \textbf{unknown 0x58}, \textbf{unknown 0x5C}, \textbf{unknown 0x60}, \textbf{unknown 0x64}, \textbf{unknown 0x68}, \textbf{unknown 0x6C}, and \textbf{unknown 0x70}. This also has an \textbf{Unknown Setting} similar to the Sphere light. In principle these settings could be mapped to the Blender ``Spot Shape", but lights should be better understood overall before implementing this.
\end{itemize}
At the end of the properties is a list of flags. Only \textbf{flag 0} seems to be used amongst the provided flags, and its purpose is unknown.
\guideimage{images/editing_models/edits_light_properties.png}
\end{guide}

\subsubsection{Model Properties}
The model as a whole carries some properties that can be edited.
\begin{itemize}
\item \textbf{Version}: The version number of the file the model was imported from.
\item \textbf{External EMT}: Whether the model uses an external EMT file.
\item \textbf{Unknown flag 3}: Purpose unknown.
\item \textbf{Auto-Rename Mesh UVs}: Does the same as the \textbf{Auto-Rename UVs} button in the mesh properties, but for every mesh of the model.
\item \textbf{Bounding Box}: Identical in operation to that for a mesh.
\item \textbf{Bounding Sphere}: Identical in operation to that for a mesh.
\end{itemize}
In addition to these properties, there are three sub-panels:
\begin{itemize}
\item \textbf{GFS Node}: The properties of the root node of the model, which is represented as the armature object. Refer to the GFS Bone section for a description of these properties.
\item \textbf{GFS Physics}: Physics properties, which are detailed in section \ref{SECTION::Edits::Model::Physics}.
\item \textbf{GFS Animation Packs}: Animation pack properties, which are detailed in section \ref{SECTION::Editing::Animations}.
\end{itemize}
\begin{guide}{Accessing Model Properties}
\item The Model Properties can be accessed in the \textbf{GFS Model} panel in the \textbf{Armature Data} properties panel with the armature selected.
\guideimage{images/editing_models/edits_model_properties.png}
\end{guide}
\subsubsection{Physics}
\label{SECTION::Edits::Model::Physics}
Physics are partially implemented. There are two main components to model physics:
\begin{itemize}
\item Physics Colliders
\item Physics Bones
\end{itemize}
Of these, \textbf{physics bones} are only accessible \textit{via} the property interface, but \textbf{physics colliders} are editable from within the editor. As described in the Model Properties section, the physics properties can be accessed as a sub-panel under the \textbf{GFS Model} panel.\\
In is panel, you will find the following properties and operators:
\begin{itemize}
\item \textbf{Copy Physics}: Copy all physics of the model to a clipboard.
\item \textbf{Paste Physics}: Paste physics from the clipboard onto the model.
\item \textbf{Show All Colliders}: Set all Colliders on the model to visible.
\item \textbf{Hide All Colliders}: Set all Colliders on the model to non-visible.
\item \textbf{Create Collider}: Create a new collider on the model.
\item \textbf{Attach to Bone}: If true, a collider added by the \textbf{Create Collider} button will be attached to a particular bone.
\item \textbf{Bone}: The bone that an added collider will be attached to.
\item \textbf{Repair Global Material}: If you have edited the material used to render colliders, this will reset the material to its default settings, or recreate it if you deleted it.
\item \textbf{Unknown 0x00}: Unknown.
\item \textbf{Unknown 0x04}: Unknown.
\item \textbf{Unknown 0x08}: Unknown.
\item \textbf{Unknown 0x0C}: Unknown.
\item \textbf{Unknown 0x10}: Unknown.
\item \textbf{Bones}: The physics bones for the model. New bones can be added, removed, and re-ordered with the buttons on the right. The properties of each bone, some of which are accessed with the\textbf{Edit} button for that bone, are:
\begin{itemize}
\item \textbf{Has Name}: If true, the physics bone is associated with a particular model bone.
\item \textbf{Name}: The bone that a physics bone is associated with.
\item \textbf{Unknown 0x00}: Unknown.
\item \textbf{Unknown 0x04}: Unknown.
\item \textbf{Unknown 0x08}: Unknown.
\item \textbf{Unknown 0x0C}: Unknown.
\item \textbf{Nameless Data}: Six extra floats that are used if a physics bone is not associated with a particular bone. Values unknown.
\end{itemize}
\item \textbf{Links}: This is a set of parent-child index pairs that form bone chains from the physics bones. The properties are:
\begin{itemize}
\item \textbf{Parent}: The index of the parent physics bone.
\item \textbf{Child}: The index of the child physics bone.
\item \textbf{Mass}: The mass of the link.
\item \textbf{Unknown 0x04}: Unknown.
\item \textbf{Radius}: The radius of the link.
\end{itemize}
\end{itemize}
In addition to these properties, each \textbf{physics collider} is represented as a mesh parented under the model armature. Instead of having \textbf{GFS Mesh} properties, it has a set of \textbf{GFS Collider} properties. These properties have the following properties:
\begin{itemize}
\item \textbf{Detached}: Whether the collider is detached from any bone or not.
\item \textbf{Type}: Either \textbf{Capsule} or \textbf{Sphere}.
\begin{itemize}
\item \textbf{Capsule}: A capsule collider. Has two properties that will update the shape of the capsule, \textbf{radius} and \textbf{height}.
\item \textbf{Sphere}: A sphere collider. Has one property that will update the shape of the sphere, \textbf{radius}.
\end{itemize}
\item \textbf{Reset Material to Global}: If the material of the collider has been changed, set the material back to the default material for colliders.
\item \textbf{Repair Global Material}: If the collider material has been edited or deleted, clicking this button will reset its properties to the default and recreate it if necessary.
\end{itemize}

\begin{guide}{Accessing Physics Properties}
\item From the \textbf{GFS Model} panel, open the \textbf{GFS Physics} sub-panel.
\guideimage{images/editing_models/edits_physics_properties.png}
\end{guide}

\clearpage
\subsection{GFS Animations}
\label{SECTION::Editing::Animations}
In this section, the three major kinds of animation are covered. Section~\ref{SECTION::Edits::Animations::AnimationPacks} covers how to organise the set of animations in an Animation Pack that can be exported. Sections~\ref{SECTION::Edits::Animations::NormalAnimations}, \ref{SECTION::Edits::Animations::BlendAnimations}, and \ref{SECTION::Edits::Animations::LookAtAnimations} cover the properties and Blender data required for the three types of animation to be exported and displayed correctly. In section~\ref{SECTION::Edits::Animations::TipsForEditing}, some useful information on editing Blend animations from within Blender is provided.

Currently, only \textbf{bone animations} are editable from within Blender. There are (at least) four other kinds of animation, but they are not exposed to the user for the following reasons:
\begin{itemize}
\item {Material Animations}
\item {Camera Animations}
\item {Animation Type 4}
\item {Morph Animations}
\end{itemize}

GFS Animations are expected to be rendered at \textbf{30 FPS}. Blender by default renders at \textbf{24 FPS}. Animations will be imported assuming a 30 FPS render speed so that animation frames can be placed at integer frame indices. You should change Blender's animation speed to 30 FPS to preview the animations at the correct speed, either by changing it in the scene properties or by checking the box to set Blender to 30 FPS in the import window.

If an animation additionally has a custom ``speed", this speed is baked into the animation frames. This will cause the animation frames to be placed at non-integer frame values.

All animation properties are found in the \textbf{GFS Animation Packs} sub-panel of the \textbf{GFS Model} sub-panel.

\subsubsection{Animation Packs}
\label{SECTION::Edits::Animations::AnimationPacks}
Animations are organised in \textbf{Animation Pack}s. These are found in a list in the \textbf{GFS Animation Packs} sub-panel of the \textbf{GFS Model} panel of the Armature Properties Panel. Within this list, each imported GAP can be ``activated" or ``deactivated", where each ``active" GAP will unpack its animations in the NLA editor. Any active GAPs are identified with a ticked checkbox.

In addition, a model can have an \textbf{internal} GAP, which can be set or removed with the relevant button. The GAP currently set as the \textbf{internal} GAP can be identified with a box icon within the GAP list. GAPs can be added, removed, and reorganised with the buttons on the side of the list.

Below this list is the ``quick activation" menu for the animations of the selected GAP.

\begin{guide}{Accessing Animation Packs}
\item Animation Pack properties can be found in the \textbf{GFS Animation Packs} sub-panel of the \textbf{GFS Model} panel of the Armature Properties Panel.
\guideimage{images/editing_models/edits_animation_pack.png}
\end{guide}


\subsubsection{Base Animations}
\label{SECTION::Edits::Animations::NormalAnimations}
``Base Animations" are regular animations. The animated quantities in these animations should override those that are present in the Rest Pose. In-game, all interpolations are done with \textbf{linear interpolation (LERP)}, except for quaternion animations which are done with \textbf{spherical linear interpolation (SLERP)}. For this reason, to ensure that the animation you see in Blender is accurately reflected in-game, you should ensure the following settings are applied:
\begin{itemize}
\item The Strip Blending should be set to \textbf{REPLACE}.
\item The keyframe interpolation should be set to \textbf{LINEAR} for all animations except for \textbf{rotation\_quaterion}, which should be set to \textbf{BEZIER}.
\end{itemize}
%See Section~\ref{SECTION::Editing::Animations::TipsForEditing::AutoCorrect}, Subitem ``Auto-Correcting Actions" for information on how to apply these settings automatically.

\textbf{Base Animations} have a set of properties that also need to be exported. Details on these are given below.

\begin{guide}{Accessing Normal Animation Properties}
\item The animation properties can be found by selecting a strip in the NLA editor and navigating to the ``GFS Animation" panel in the ``Strip" sidebar panel. You can use the \keystroke{N} key to open and close the sidebar whilst the mouse cursor is inside the NLA editor.
\item The \textbf{Category} should be set to ``Normal". Most of the \textbf{Unknown Flags} are unused. The first five flags are usually ticked if the following animations are present:
\begin{enumerate}
\item Flag 0 - Bone animations
\item Flag 1 - Material animations
\item Flag 2 - Camera animations
\item Flag 3 - Unknown animations
\item Flag 4 - Morph animations
\end{enumerate}
but since these do not seem to influence how animations are displayed and do not have an exact correspondence to these types of animation being present, they are left as unnamed flags for now.
\guideimage{images/editing_models/edits_normal_animations_1.png}
\item Further down, you can set ``Look At" animations for a Normal Animation. A \textbf{LookAt animation} is a kind of \textbf{Blend Animation} that makes a character look up, down, left, and right. Further details can be found in sections~\ref{SECTION::Edits::Animations::BlendAnimations} and \ref{SECTION::Edits::Animations::LookAtAnimations}. If you tick the box saying that an animation has lookat animations, you \textbf{must select all four animations you want to use as lookats} in order to successfully export. You can do this by clicking the animation boxes and selecting the animation that pops up. The only available animations are those that have been given the \textbf{LookAt} category.
The role of the LookAt factors is unknown.
In addition, animations can have GFS Properties like bones can. See section~\ref{SECTION::GfsProperties} for more information.
\guideimage{images/editing_models/edits_normal_animations_2.png}
\end{guide}

\subsubsection{Blend Animations}
\label{SECTION::Edits::Animations::BlendAnimations}
\textbf{Blend Animations} are animations that are overlaid on \textbf{Normal Animations}. The animations are combined by combining each transformation channel individually. Positions and scales are added, and quaternions are combined with quaternion multiplication. Therefore, the Strip Blending type should be set to \textbf{COMBINE}. Keyframe interpolation should be handlded the same as the \textbf{Normal Animations}. However, Blender will attempt to \textbf{multiply} scale channels instead of adding them under the \textbf{COMBINE} Strip Blending mode. For this reason, scales should be separated to their own action with the \textbf{ADD} Strip Blending mode, and given the special \textbf{Blend Scale} category rather than the \textbf{Blend} category. Details on this are given in the Blend Properties Step-By-Step below, which also discusses other Blend animation properties. This means that any scales present in a \textbf{Blend Animation} will be ignored on export, and instead taken from a linked \textbf{Blend Scale Animation} if one is present.
\begin{guide}{Accessing Blend Animation Properties}
\item The \textbf{category} for Blend animations is \textbf{Blend}. The \textbf{Unknown Flags} are the same as the \textbf{Normal Animations}.
\guideimage{images/editing_models/edits_blend_animations_1.png}
\item Instead of \textbf{LookAt} animations, \textbf{Blend} animations can link to a \textbf{Blend Scale} animation as described above. To link a \textbf{Blend Scale} animation, select one from the dropdown.
\guideimage{images/editing_models/edits_blend_animations_2.png}
\end{guide}

\subsubsection{LookAt Animations}
\label{SECTION::Edits::Animations::LookAtAnimations}
A \textbf{LookAt} animation is a special \textbf{Blend} animation used to represent looking left, right, up, and down. This is typically just a single frame representing the pose. \textbf{Normal Animations} can link to a \textbf{LookAt} animation from their properties panel. If the \textbf{LookAt} animation is not linked to a \textbf{Normal Animation}, it will not be exported.
\begin{guide}{Accessing LookAt Animation Properties}
\item The \textbf{category} for a \textbf{LookAt} animation is \textbf{LookAt}. All properties are the same as \textbf{Blend Animations}.
\guideimage{images/editing_models/edits_lookat_animations.png}
\end{guide}

\subsubsection{Tips for Editing Animations in Blender}
\label{SECTION::Edits::Animations::TipsForEditing}

\paragraph{Auto-Correcting Actions}
\label{SECTION::Editing::Animations::TipsForEditing::AutoCorrect}
\begin{guide}{Auto-Correcting Actions}
\item The interpolation and strip blending of an NLA strip and action can be automatically set when switching the action type. Do this inside the Animation Properties.
\item The animation properties can be found by selecting a strip in the NLA editor and navigating to the ``GFS Animation" panel in the ``Strip" sidebar panel. You can use the \keystroke{N} key to open and close the sidebar whilst the mouse cursor is inside the NLA editor.
\item Check the \textbf{Auto-Correct Action} box.
\guideimage{images/editing_models/edits_autocorrect_animations.png}
\item Changing the animation \textbf{category} will now automatically change the interpolation and strip blending types for those appropriate for the selected category. This will not be done when first checking the box, so switch to a different category and back to apply the changes.
\end{guide}

\paragraph{Previewing with the NLA Editor}
\label{SECTION::Editing::Animations::TipsForEditing::PreviewingNLA}
\begin{guide}{Previewing with the NLA Editor}
\item Unmute whichever animations you want to preview. You should unmute a \textbf{single} \textbf{Normal Animation} plus whatever \textbf{Blend Animation}s you want to see overlaid on it.
\item The \textbf{Rest Pose} should \textbf{always} be unmuted.
\item Actions at the \textbf{top} of the editor have the highest priority. Should should have the \textbf{Rest Pose} at the bottom, followed by the \textbf{Normal Animations}, and then any \textbf{Blend Animations}.
\guideimage{images/editing_models/edits_previewing_blends_1.png}
\end{guide}

\paragraph{Previewing Blend Animations during Editing}
\label{SECTION::Editing::Animations::TipsForEditing::PreviewingBlends}
\begin{guide}{Previewing Blend Animations during Editing}
\item Unmute whichever \textbf{Normal Animation} you want to use as a base, and the \textbf{Blend Animation} you want to edit in the NLA editor.
\guideimage{images/editing_models/edits_previewing_blends_1.png}
\item Press \keystroke{Tab} to pin the action to the Action Editor.
\guideimage{images/editing_models/edits_previewing_blends_2.png}
\item You can now edit the action in the Action Editor whilst previewing the full effect of the other umutued NLA tracks.
\end{guide}

\clearpage

\subsection{GFS Properties}
\label{SECTION::GfsProperties}
Bones, armatures, meshes, and animations can have additional \textbf{GFS properties}. These can be added with the \textbf{GFS Properties} collection widget in their corresponding UI panels. When adding a property, you will be required to provide a name, data type, and then the data the property will store. Although the name fields are free text fields, there do appear to be specific properties that are looked for and will do certain things. For this reason the properties box may be replaced with sub-panels implementing this behvaviour automatically once it is fully understood. For now, like with everything else that isn't fully understood about the format, any edits you make will have to be somewhat manual.

\begin{guide}{Manipulating GFS Properties}
\item Navigate the the properties panel for the selected object.
\item Within the object's properties panel, locate the \textbf{GFS Node} subpanel. Within that panel, locate the \textbf{Properties} subpanel.
\item Properties attached to the object will be displayed in the box. The selected property is highlighted in a different colour. You can add, remove, and re-order properties with the four buttons on the right of the box.
\item Change the name of a property by editing the value in the leftmost box.
\item Change the property data type by selecting a value from the dropdown.
\item Change the attached data by editing the rightmost box(es).
\guideimage{images/editing_models/edits_gfs_properties.png}
\end{guide}

\clearpage

\subsection{EPLs}
\label{SECTION::Edits::Epls}
EPL files are not currently editable in Blender. GFS files containing EPLs are loadable, but the EPL data will not be accessible. GFS files contained within EPLs can be extracted by other programs or by using this plugin as a library for the Python programming language, as described in section~\ref{SECTION::PythonLibrary}. These extracted GFS files may then be possible to open in Blender, edit, and then re-inject into the EPL files with other programs or \textit{via} the Python interface. Note however that, as of this version of the plugin, this is not well-tested nor intended to be an end-user feature. Users are welcome to use the library in this way, but are reminded that since it is an unsupported part of the library, pull requests that improve the feature are significantly more likely to get attention than issue tickets asking for improvements to it.

If sections of EPLs can be sensibly imported and exported from Blender, such as submodels, EPLs may be better supported in future versions of the plugin.

\clearpage

\section{Export}
\subsection{Exporting Model (GMD/GFS) Files}
\label{SECTION::EXPORT::ExportingModels}
\begin{guide}{Accessing the Model Export Menu}
\item Open the File menu and navigate to the \textbf{Export} \textgreater\space \textbf{GFS} \textgreater\space \textbf{GFS Model} submenu item.
\guideimage{images/export/export_gmd.png}
\item From the export options on the right, choose:
\begin{itemize}
\item Whether to export animations packed into the model.
\item Whether to strip any vertex groups from the export that do not correspond to a bone in the armature. Leaving this option unticked means that undefined vertex groups will cause an error when attempting to export.
\item Whether to recalculate tangents on export if a mesh needs to be exported with tangents. This can be useful if an imported model has incorrect tangent vectors, and if the Blender tangent calculator gives better results. This is active by default.
\item Whether to throw an error us any vertices in a rigged mesh are unrigged. A warning will be displayed if this is turned off, and if it is turned on then the export will stop on the first mesh that raises this error and Blender will display all vertices that are unrigged.
\item Which file version to export as.
\end{itemize}
\guideimage{images/export/export_gmd_properties.png}
\item Set a filename and export.
\end{guide}

\subsection{Exporting Animation (GAP) Files}
\label{SECTION::EXPORT::ExportingAnimations}
\begin{guide}{Accessing the Animation Export Menu}
\item Open the File menu and navigate to the \textbf{Export} \textgreater\space \textbf{GFS} \textgreater\space \textbf{GAP Animation} submenu item.
\guideimage{images/export/export_gap.png}
\item From the export options on the right, choose which file version to export as.
\guideimage{images/export/export_gap_properties.png}
\item Set a filename and export.
\end{guide}

\clearpage

\section{BlenderToolsForGFS as a Python Library}
\label{SECTION::PythonLibrary}
\textbf{NOTE: This section is for users of the Python programming language who wish to write scripts using the plugin. A user will not get much out of this section without some knowledge of Python. if you need to use the library's scripting API, you are encouraged to pick up the basics of Python using the wealth of information freely available on the internet.}\\\\
\noindent
\textbf{NOTE: The API is currently unstable. This document should be correct for whatever release of the tools it is labelled for, but the same cannot be said for development versions. The documentation should be fully updated once feature development for each new release is complete. You should expect the API to change between versions as the file format becomes better understood and smarter ways of arranging and creating data become clear.}
\\\\
\noindent
The Blender plugin can also be used as a plain Python library for manipulating GFS and EPL files. This is possible because all Blender-related code is not loaded by default when initialising the plugin, and because the file-editing code is well-separated from the Blender interface. Furthermore, the non-Blender part of the plugin only utilises the standard library, and therefore no additional third-party libraries are required in order to use the plugin as a library. Using the plugin in this manner is outlined in section \ref{SECTION::UsingAsAPythonLibrary}. \textbf{However, bear in mind that this is not fully documented since it is not yet intended as an end-user feature. Adventurous users can use the Python API, but should bear in mind that there are many ways to create annoying data inconsistencies. This can be remedied with further development to make the Python API safer to use by an end-user.}

If you have the `bpy' package installed, you can activate the plugin's Blender interface and write Blender scripts outside of Blender. You can also write these scripts inside Blender with the scripting feature. Notes on how to use the plugin in this manner are given in \ref{SECTION::UsingAsABlenderPlugin}.

\subsection{Python Library Usage}
\label{SECTION::UsingAsAPythonLibrary}
GMD, GFS, GAP, and EPL files can be manipulated with the Python API, which can be imported independently from the Blender Interface.

\subsubsection{GFS/GMD/GAP}
The first thing to do is to import the \textbf{GFSInterface} object.
\begin{lstlisting}[style=pythonstyling]
from BlenderToolsForGFS import GFSInterface
\end{lstlisting}
This object can be used to access various elements of the file. First of all, you will need to load a file.
\begin{lstlisting}[style=pythonstyling]
gi = GFSInterface.from_file(filepath=...) 
\end{lstlisting}
The GFSInterface can be written to a file with the \textbf{to\_file(filepath, version)} method.
\begin{lstlisting}[style=pythonstyling]
# version is an int, e.g. 0x01105100
gi.to_file(filepath=..., version=...)
\end{lstlisting}

The available attributes of the GFSInterface are given below.\\
These are likely to be changed to read-only properties with \textbf{add()} and \textbf{remove()} methods in the future.
\begin{center}
\begin{longtable}{p{.2\textwidth}p{.33\textwidth}p{.46\textwidth}}
\hline
Name & Type & Description\\
\hline
meshes & List[MeshInterface] & A list of meshes.\\
cameras & List[CameraInterface] & A list of cameras.\\
lights & List[LightInterface] & A list of lights.\\
epls & List[EPLInterface] & A list of epls.\\
bones & List[NodeInterface] & A list of nodes/bones.\\
materials & List[MaterialInterface] & A list of materials.\\
textures & List[TextureInterface] & A list of textures.\\
animations & List[AnimationInterface] & A list of normal animations.\\
blend\_animations & List[AnimationInterface] & A list of blend animations.\\
lookat\_animations & LookAtAnimationsInterface & A container for the global lookat animations.\\
\hline
\end{longtable}
\end{center}

New elements can be added to these attributes with the following methods.
\begin{center}
\begin{longtable}{p{.15\textwidth}p{.2\textwidth}p{.25\textwidth}p{.39\textwidth}}
\hline
Name & Return & Inputs & Input Description\\
\hline
add\_mesh & MeshInterface & node\_id & Node that the MeshInterface should be attached to.\\
& & vertices & A list of Vertex objects.\\
& & material\_name & The name of the material used by the mesh.\\
& & indices & Vertex indices that are used to create the triangles. This is a flat list, with every three indices creating a triangle.\\
& & morphs & A list of lists of 3D position vectors. Each sub-list represents a position offset for its corresponding vertex. Each sub-list should have the same number of entries as the mesh vertices.\\
& & unknown\_0x12 & Unknown integer. Usually 0.\\
& & unknown\_float\_1 & Unknown float. May be None is unknown\_float\_2 is also None.\\
& & unknown\_float\_2 & Unknown float. May be None is unknown\_float\_1 is also None.\\
& & keep\_bounding\_box & Bool. Whether to create a bounding box on export.\\
& & keep\_bounding\_sphere & Bool. Whether to create a bounding sphere on export.\\
\hline
add\_camera & CameraInterface & node\_id & Node that the CameraInterface should be attached to.\\
& & view\_matrix & A row-major 4x4 transform matrix represented as a flat list of 16 elements.\\
& & zNear & The near clip distance.\\
& & zFar & The far clip distance.\\
& & fov & The Field of View in degrees.\\
& & aspect\_ratio & The aspect ratio.\\
& & unknown\_0x50 & Unknown float.\\
\hline
add\_light & LightInterface & node\_id & Node that the LightInterface should be attached to.\\
& & type & 1 = Type1, 2 = Sphere, 3 = Hemisphere.\\
& & color\_1 & A 4-vector representing an RGBA color. Apparently unused.\\
& & color\_2 & A 4-vector representing an RGBA color. Main light color.\\
& & color\_3 & A 4-vector representing an RGBA color. Apparently unused.\\
\hline
add\_epl & EPLInterface & node\_id & Node that the EPL should be attached to.\\
& & binary & An EPLBinary object. \textbf{You can create EPLBinaries manually, but it is recommended to consider this function off-limits for creating new EPLs}.\\
\hline
add\_node & NodeInterface & parent\_idx & Index of the NodeInterface's parent NodeInterface.\\
 & & position & 3D position vector.\\
 & & rotation & XYZW quaternion.\\
 & & scale & 3D scale vector.\\
 & & unknown\_float & Unknown.\\
 & & bind\_pose\_matrix & A row-major 4x4 transform matrix represented as a flat list of 16 elements.\\
\hline
add\_material & MaterialInterface & name & The material name.\\
\hline
add\_texture & TextureInterface & name & The texture name.\\
& & data & A bytes-like object representing raw data for a DDS file.\\
& & unknown\_1 & Unknown int. Usually 1.\\
& & unknown\_2 & Unknown int. Usually 1.\\
& & unknown\_3 & Unknown int. Usually 0.\\
& & unknown\_4 & Unknown int. Usually 0.\\
\hline
\end{longtable}
\end{center}

\textbf{TODO: Description of each Interface}

\subsubsection{EPL}
\textbf{TODO}

\subsection{Blender Script Usage}
\label{SECTION::UsingAsABlenderPlugin}
Most Blender scripts will need to begin by importing the \textbf{bpy} module.
\begin{lstlisting}[style=pythonstyling]
import bpy
\end{lstlisting}

If you are writing a script outside of Blender, you will also need to add the \textbf{BlenderToolsForGFS} module to your import path (or create your python script in the same directory as a copy of the BlenderToolsForGFS library), and then import and register the module with Blender by calling the module's \textbf{register()} method.
\begin{lstlisting}[style=pythonstyling]
import BlenderToolsForGFS
BlenderToolsForGFS.register()
\end{lstlisting}

After the module is registered, you can import and export data using the operators that the plugin adds for these purposes.
\begin{lstlisting}[style=pythonstyling]
bpy.ops.import_file.import_gfs(filepath=...)
bpy.ops.import_file.import_gap(filepath=..., armature_name=...)

# Need to select the armature in order to use export functions
bpy.data.objects[...].select_set(True)

bpy.ops.export_file.export_gfs(filepath=...)
bpy.ops.export_file.export_gap(filepath=...)
\end{lstlisting}

These operators have the following keyword arguments:
\begin{center}
\begin{tabular}{p{.2\textwidth}p{.1\textwidth}p{.69\textwidth}}
\hline
\multicolumn{3}{c}{import\_gfs}\\
Keyword & Type & Description\\
\hline
filepath & string & The filepath to the file to import.\\
set\_fps & bool & Switches Blender animation to 30 FPS. Default: False.\\
debug\_mode & bool & Allows exceptions to be raised instead of silently suppressed by popup windows. Default: False.\\
merge\_vertices & bool & Attempts to create a manifold mesh out of the input vertices. Default: True.\\
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{p{.2\textwidth}p{.1\textwidth}p{.69\textwidth}}
\hline
\multicolumn{3}{c}{import\_gap}\\
Keyword & Type & Description\\
\hline
filepath & string & The filepath to the file to import.\\
set\_fps & bool & Switches Blender animation to 30 FPS. Default: False.\\
debug\_mode & bool & Allows exceptions to be raised instead of silently suppressed by popup windows. Default: False.\\
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{p{.2\textwidth}p{.1\textwidth}p{.69\textwidth}}
\hline
\multicolumn{3}{c}{export\_gfs}\\
Keyword & Type & Description\\
\hline
filepath & string & The filepath to the file to import.\\
version & string & The file version to export as. Default: 0x01105100.\\
debug\_mode & bool & Allows exceptions to be raised instead of silently suppressed by popup windows. Default: False.\\
pack\_animations & bool & Whether to pack animations into the model or not. Default: False.\\
\hline
\end{tabular}
\end{center}

\begin{center}
\begin{tabular}{p{.2\textwidth}p{.1\textwidth}p{.69\textwidth}}
\hline
\multicolumn{3}{c}{export\_gap}\\
Keyword & Type & Description\\
\hline
filepath & string & The filepath to the file to import.\\
version & string & The file version to export as. Default: 0x01105100.\\
debug\_mode & bool & Allows exceptions to be raised instead of silently suppressed by popup windows. Default: False.\\
\hline
\end{tabular}
\end{center}

\textbf{TODO: Custom PropertyGroups}
\clearpage

\section{Future Development}
Listed here are a few directions that future development could go. This is not a promise of feature development; just an inexhaustive record of ideas for any contributors who might want to improve the tools in some fashion.
\subsection{Blender Interface}
\begin{itemize}
\item Create an accurate Shader Node for GFS materials. This will require the material data structures to be fully researched beforehand.
\item Redesign the animation import/export so that more than just node animations can be imported. Material animations would need to be somehow linked to a corresponding node animation, and so forth. An idea on how to do this would be to have a list of exported animations on the animation pack, and each animation entry can contain a \textbf{CollectionProperty} of \textbf{PointerProperties} to \textbf{bpy.types.Action}s. Each animation can additionally have a checkbox next to it that will mute or unmute \textbf{bpy.types.Action}s that are linked to it simultaneously, so that the user does not have to indivudually unmute every animation on every object to preview the entire animation.
\item Related to the above: a \textbf{CollectionProperty} of Animation Packs could be implemented so that multiple Animation Packs can be imported and exported. Since we would already be collecting exported animations into a \textbf{CollectionProperty}, that would just mean that each AnimationPack would be in charge of its own \textbf{CollectionProperty} of animations.
\item After the previous points are implemented and are guaranteed to work well both technically and from a user's perspective, then material, camera, and morph animations can be added.
\item Physics colliders and joint physics can be imported as meshes with rigid body physics and a bunch of properties. Buttons to generate these meshes can be added to a menu somewhere.
\item EPL submodels should be imported into the scene tree too, but only after the animation and material refactors have been implemented.
\item GFS Properties could be turned into a group of settings instead of an arbitrary list (or both could be available). For example, any Properties required to create collision triggers could be added with a subpanel rather than asking the user to copy out a list of collision properties. However, the various sets of properties would have to first be researched and property understood.
\item The vertex-merging algorithm should be refactored to work by merging vertices such that \textbf{any face} will not be removed, rather than just checking if there are two overlapping antiparallel faces.
\end{itemize}

\subsection{Python API}
\begin{itemize}
\item RootNodes should be moved out of the node list. Any parentless nodes in the GFS node list should be automatically parented to the RootNode, which must always exist by construction. Currently the GFSInterface is fragile, in the sense that if the first node is \textit{not} the root node, everything explodes.
\item Cameras need a proper Interface.
\item Lights need a proper Interface.
\item The AnimationInterface needs to be more cleanly designed: it currently has a lot of awkward heuristics to serialise node animations and can duplicate tracks and so forrth due to a lack of understanding of how all the animation keys work.
\end{itemize}

\clearpage

\end{document}
